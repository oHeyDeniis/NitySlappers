"use strict";var x=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(c,e)=>{for(var t in e)x(c,t,{get:e[t],enumerable:!0})},ie=(c,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Z(e))!ee.call(c,n)&&n!==t&&x(c,n,{get:()=>e[n],enumerable:!(i=X(e,n))||i.enumerable});return c};var ne=c=>ie(x({},"__esModule",{value:!0}),c);var ae={};te(ae,{default:()=>se});module.exports=ne(ae);var Y=require("@serenityjs/plugins");var S=require("@serenityjs/core");var g=require("@serenityjs/core"),k=require("console"),p=require("@serenityjs/protocol");var h=require("@serenityjs/core");var y=require("@serenityjs/core"),b=require("@serenityjs/protocol");var V=require("@serenityjs/nbt"),G=require("console"),M=class c extends y.Entity{constructor(e={},t,i){let n=new V.CompoundTag,r=BigInt(997);n.set("UniqueID",new V.LongTag(BigInt(997),"UniqueID")),super(t,"slapper_entity_type",{storage:i?.storage??n}),this.position=e.position||new b.Vector3f(0,0,0);let d=this.getSlapperEntityTrait();this.rotation.yaw=e.rotation?.yaw||0,this.rotation.pitch=e.rotation?.pitch||0,this.rotation.headYaw=e.rotation?.headYaw||0,d.uuid=e.uuid||c.generateUUID(),d.skin=e.skin||b.SerializedSkin.empty(),d.displayName=e.displayName||"Slapper",d.itemInHand=e.itemInHand||y.ItemStack.empty(),d.setArmor(e.armor||{}),d.setId(e.entityId||Math.floor(Math.random()*1e5)),this.hasTrait(y.PlayerEntityRenderingTrait)&&this.removeTrait(y.PlayerEntityRenderingTrait),this.hasTrait(y.PlayerHungerTrait)&&this.removeTrait(y.PlayerHungerTrait),this.addTrait(f),this.storage.setIdentifier(this.type.identifier),this.storage.setUniqueId(r),this.storage.setPosition(this.position),(0,G.log)(`SlapperEntity created with UUID: ${d.getUuid()} and ID: ${d.getId()}`)}spawn(e){return this}despawn(e){return this.isAlive=!1,this.dimension.entities.delete(this.uniqueId),this.getRenderingTrait().despawnForAllViewers(),this}getRenderingTrait(){return this.getTrait(f)??this.addTrait(f)}getSlapperEntityTrait(){return this.getTrait(a)??this.addTrait(a)}static generateUUID(){let e="slapper";function t(m){return Array.from({length:m},()=>Math.floor(Math.random()*16).toString(16)).join("")}let i=t(8),n=t(4),r=t(4),d=t(4),u=t(12);return`${i}-${n}-${r}-${d}-${u}`}send(...e){}sendImmediate(...e){this.send(...e)}isPlayer(){return!0}getGamemode(){return this.gamemode}gamemode=this.world.getDefaultGamemode();isOp=!1;clientSystemInfo={identifier:"unknown",os:b.DeviceOS.Android};abilities=new y.PlayerAbilities(this)};var W=require("console"),T=require("@serenityjs/protocol");var s=require("@serenityjs/nbt"),a=class extends h.EntityTrait{identifier="slapper_entity_trait";static identifier="slapper_entity_trait";static types=[h.EntityIdentifier.Player,"slapper_entity_type"];id=-1;uuid="00000000-0000-0000-0000-000000000021";skin=T.SerializedSkin.empty();displayName="Slapper";itemInHand=h.ItemStack.empty();helmet=h.ItemStack.empty();chestplate=h.ItemStack.empty();leggings=h.ItemStack.empty();boots=h.ItemStack.empty();getUuid(){return this.entity.getStorageEntry("SlapperUUID")?.valueOf()||this.uuid}getId(){return this.entity.getStorageEntry("SlapperID")?.valueOf()||this.id}setId(e){this.entity.setStorageEntry("SlapperID",new s.IntTag(e,"SlapperID")),this.id=e}setUuid(e){this.entity.setStorageEntry("SlapperUUID",new s.StringTag(e,"SlapperUUID")),this.uuid=e}getDisplayName(){return this.entity.getStorageEntry("SlapperDisplayName")?.valueOf()||this.displayName}setDisplayName(e){this.entity.setStorageEntry("SlapperDisplayName",new s.StringTag(e,"SlapperDisplayName")),this.entity.setNametagAlwaysVisible(!0),this.entity.setNametag(e),this.displayName=e,this.getRenderingTrait().updateDisplayName()}getItemInHand(){return this.itemInHand}setItemInHand(e){this.itemInHand=e}addCommand(e){let t=this.entity.getStorageEntry("SlapperCommandsList")??new s.ListTag([],"SlapperCommandsList"),i=this.getCommands();i.push(e);let n=[];for(let d of i)n.push(new s.StringTag(d,d));let r=new s.ListTag(n,"SlapperCommandsList");this.entity.setStorageEntry("SlapperCommandsList",r)}getCommands(){let e=this.entity.getStorageEntry("SlapperCommandsList"),t=[];if(e){for(let i of e.values())t.push(i?.valueOf()??"");return t}else return[]}removeCommand(e){if(this.entity.getStorageEntry("SlapperCommandsList")){let i=this.getCommands(),n=i.indexOf(e);n>-1&&i.splice(n,1);let r=[];for(let u of i)r.push(new s.StringTag(u,u));let d=new s.ListTag(r,"SlapperCommandsList");this.entity.setStorageEntry("SlapperCommandsList",d)}}setArmor(e){e.helmet!==void 0&&(this.helmet=e.helmet),e.chestplate!==void 0&&(this.chestplate=e.chestplate),e.leggings!==void 0&&(this.leggings=e.leggings),e.boots!==void 0&&(this.boots=e.boots),this.getRenderingTrait().updateArmorForViewers([])}getArmor(e){switch(e){case"helmet":return this.helmet;case"chestplate":return this.chestplate;case"leggings":return this.leggings;case"boots":return this.boots}}getSkin(){let e=T.SerializedSkin.empty(),t=this.entity.getStorageEntry("SlapperSkin");if(t){e.identifier=t.get("Identifier")?.valueOf()||e.identifier,e.playFabIdentifier=t.get("PlayFabIdentifier")?.valueOf()||e.playFabIdentifier;let i=t.get("SkinImageWidth")?.valueOf()||0,n=t.get("SkinImageHeight")?.valueOf()||0,r=t.get("SkinImageData")?.valueOf()||"";e.skinImage=new T.SkinImage(i,n,Buffer.from(r,"base64")),e.skinColor=t.get("SkinColor")?.valueOf()||e.skinColor,e.armSize=t.get("ArmSize")?.valueOf()||e.armSize,e.resourcePatch=t.get("ResourcePatch")?.valueOf()||e.resourcePatch,e.geometryData=t.get("GeometryData")?.valueOf()||e.geometryData,e.geometryVersion=t.get("GeometryVersion")?.valueOf()||e.geometryVersion,e.fullIdentifier=t.get("FullIdentifier")?.valueOf()||e.fullIdentifier}return e}setSkin(e){this.skin=e;let t={identifier:this.skin.identifier,armSize:this.skin.armSize,width:this.skin.skinImage.width,height:this.skin.skinImage.height,buffer:this.skin.skinImage.data.toString("base64"),color:this.skin.skinColor,playFabIdentifier:this.skin.playFabIdentifier,recourcePatch:this.skin.resourcePatch,geometryData:this.skin.geometryData,geometryVersion:this.skin.geometryVersion,fullIdentifier:this.skin.fullIdentifier},i=new s.CompoundTag;i.set("Identifier",new s.StringTag(t.identifier,"Identifier")),i.set("PlayFabIdentifier",new s.StringTag(t.playFabIdentifier,"PlayFabIdentifier")),i.set("SkinImageWidth",new s.IntTag(t.width,"SkinImageWidth")),i.set("SkinImageHeight",new s.IntTag(t.height,"SkinImageHeight")),i.set("SkinImageData",new s.StringTag(t.buffer,"SkinImageData")),i.set("SkinColor",new s.StringTag(t.color,"SkinColor")),i.set("ArmSize",new s.StringTag(t.armSize,"ArmSize")),i.set("ResourcePatch",new s.StringTag(t.recourcePatch,"ResourcePatch")),i.set("GeometryData",new s.StringTag(t.geometryData,"GeometryData")),i.set("GeometryVersion",new s.StringTag(t.geometryVersion,"GeometryVersion")),i.set("FullIdentifier",new s.StringTag(t.fullIdentifier,"FullIdentifier")),this.entity.setStorageEntry("SlapperSkin",i),this.getRenderingTrait().updateSkinForViewers([])}onInteract(e,t){for(let i of this.getCommands())try{if(i.includes("@p")){let n=i.replace(/@p/g,e.username);e.dimension.executeCommand(n)}else e.executeCommand(i)}catch{(0,W.log)("Error executing slapper commands: "+i)}}getRenderingTrait(){return this.entity.getTrait(f)??this.entity.addTrait(f)}getSavedPosition(){let e=this.entity.getStorageEntry("Pos");if(e){let t=[...e.values()],i=t[0].valueOf(),n=t[1].valueOf(),r=t[2].valueOf();return new T.Vector3f(i,n,r)}else throw new Error("Entity position not found in level storage.")}static createPreStorage(e,t,i,n,r,d,u){let m=new s.CompoundTag;m.set("identifier",new s.StringTag("slapper_entity_type","identifier")),m.set("UniqueID",new s.LongTag(BigInt(r),"UniqueID")),m.set("SlapperUUID",new s.StringTag(n,"SlapperUUID")),m.set("SlapperID",new s.IntTag(r,"SlapperID")),m.set("SlapperDisplayName",new s.StringTag(i,"SlapperDisplayName")),m.set("SlapperCommands",new s.StringTag(d.join(","),"SlapperCommands"));let l=new s.CompoundTag;l.set("Identifier",new s.StringTag(t.identifier,"Identifier")),l.set("PlayFabIdentifier",new s.StringTag(t.playFabIdentifier,"PlayFabIdentifier")),l.set("SkinImageWidth",new s.IntTag(t.skinImage.width,"SkinImageWidth")),l.set("SkinImageHeight",new s.IntTag(t.skinImage.height,"SkinImageHeight")),l.set("SkinImageData",new s.StringTag(t.skinImage.data.toString("base64"),"SkinImageData")),l.set("SkinColor",new s.StringTag(t.skinColor,"SkinColor")),l.set("ArmSize",new s.StringTag(t.armSize,"ArmSize")),l.set("ResourcePatch",new s.StringTag(t.resourcePatch,"ResourcePatch")),l.set("GeometryData",new s.StringTag(t.geometryData,"GeometryData")),l.set("GeometryVersion",new s.StringTag(t.geometryVersion,"GeometryVersion")),l.set("FullIdentifier",new s.StringTag(t.fullIdentifier,"FullIdentifier")),m.set("SlapperSkin",l);let P=new s.ListTag([new s.FloatTag(e.x),new s.FloatTag(e.y),new s.FloatTag(e.z)],"Pos");m.set("Pos",P);let v=new s.ListTag([new s.FloatTag(u.yaw),new s.FloatTag(u.pitch)],"Rotation");return m.set("Rotation",v),m}onAdd(){if(!(this.entity instanceof M)&&this.entity.type.identifier!=="slapper_entity_type"){this.entity.removeTrait(this.identifier);return}for(let e of[h.EntityEquipmentTrait,h.EntityNameableTrait])this.entity.addTrait(e);this.entity.setNametag(this.getDisplayName()),this.entity.setNametagAlwaysVisible(!0)}static generateUUID(){let e="slapper";function t(m){return Array.from({length:m},()=>Math.floor(Math.random()*16).toString(16)).join("")}let i=t(8),n=t(4),r=t(4),d=t(4),u=t(12);return`${i}-${n}-${r}-${d}-${u}`}};var f=class extends g.EntityTrait{identifier="slapper_rendering_trait";static identifier="slapper_rendering_trait";static types=[g.EntityIdentifier.Player,"slapper_entity_type"];viewers=new Map;addViewer(e){this.hasViewer(e)||!e.isAlive||!e.isTicking||(this.viewers.set(e.uniqueId,e),this.spawnToViewer(e))}removeViewer(e){this.hasViewer(e)&&(this.despawnFromViewer(e),this.viewers.delete(e.uniqueId))}hasViewer(e){return this.viewers.has(e.uniqueId)}spawnToViewer(e){let t=new p.AddPlayerPacket,i=this.getSlapperEntityTrait(),n=this.entity;t.uuid=i.getUuid(),t.username=i.getDisplayName(),(0,k.log)("Spawning slapper with name: "+t.username+" to viewer "+e.username),t.runtimeId=this.entity.runtimeId,t.platformChatId="",t.position=i.getSavedPosition()??n.position,t.velocity=n.velocity,t.pitch=n.rotation.pitch,t.yaw=n.rotation.yaw,t.headYaw=n.rotation.headYaw,t.heldItem=i.getItemInHand()===null?new p.NetworkItemStackDescriptor(0):g.ItemStack.toNetworkStack(i.getItemInHand()),t.gamemode=p.Gamemode.Creative,t.data=n.metadata.getAllActorMetadataAsDataItems(),t.properties=n.sharedProperties.getSharedPropertiesAsSyncData(),t.uniqueEntityId=n.uniqueId,t.premissionLevel=p.PermissionLevel.Operator,t.commandPermission=p.CommandPermissionLevel.Normal,t.abilities=[],t.links=[];let r={identifier:"unknown",os:p.DeviceOS.Android};t.deviceId=r.identifier,t.deviceOS=r.os,e.send(t),setTimeout(()=>this.updateAllForViewers([e]),200),e.sendMessage("Slapper spawned for you!")}despawnFromViewer(e){let t=this.entity,i=new p.RemoveEntityPacket;i.uniqueEntityId=t.uniqueId,e.send(i)}updateAllForViewers(e){this.updateSkinForViewers(e),this.updateItemInHandForViewers(e),this.updateArmorForViewers(e)}onDespawn(e){this.despawnForAllViewers()}onRemove(){this.despawnForAllViewers()}updateDisplayName(){for(let e of this.viewers.values())this.despawnFromViewer(e),setTimeout(()=>{this.spawnToViewer(e)},200);(0,k.log)("Sent display name update for slapper entity "+this.entity.uniqueId+" to viewers.")}updateSkinForViewers(e){let t=this.entity,i=this.getSlapperEntityTrait(),n=i.getSkin(),r=new p.PlayerSkinPacket;r.skin=n,r.uuid=i.getUuid(),r.skinName=n.identifier,r.oldSkinName=n.identifier+"_old",r.isVerified=!0;let d=e.length>=1?e:Array.from(this.viewers.values());this.dimension.broadcast(r)}updateItemInHandForViewers(e){let t=this.entity,n=this.getSlapperEntityTrait().getItemInHand(),r=e.length>=1?e:Array.from(this.viewers.values())}updateArmorForViewers(e){let t=this.entity,i=new p.MobArmorEquipmentPacket;i.runtimeId=t.runtimeId;let n=this.getSlapperEntityTrait();i.helmet=g.ItemStack.toNetworkStack(n.getArmor("helmet")),i.chestplate=g.ItemStack.toNetworkStack(n.getArmor("chestplate")),i.leggings=g.ItemStack.toNetworkStack(n.getArmor("leggings")),i.boots=g.ItemStack.toNetworkStack(n.getArmor("boots")),i.body=g.ItemStack.toNetworkStack(g.ItemStack.empty());let r=e.length>=1?e:Array.from(this.viewers.values());for(let d of r)d.send(i)}getSlapperEntityTrait(){return this.entity.getTrait(a)??this.entity.addTrait(a)}onAdd(){if(this.entity.type.identifier!=="slapper_entity_type"){this.entity.removeTrait(this.identifier),(0,k.log)(`SlapperRederingTrait can only be applied to SlapperEntity. Trait removed from entity ${this.entity.uniqueId}`),(0,k.log)("identifier: "+this.entity.identifier);return}(0,k.log)("identifier: "+this.entity.identifier),(0,k.log)(`SlapperRederingTrait added to entity ${this.entity.uniqueId}`),this.dimension.entities.set(this.entity.uniqueId,this.entity),this.entity.isAlive=!0}despawnForAllViewers(){for(let e of this.viewers.values())this.despawnFromViewer(e);this.viewers.clear()}onTick(e){if(this.entity.isAlive&&e.currentTick%20n===0n){for(let t of this.dimension.getPlayers()){let i=t.getTrait(g.PlayerChunkRenderingTrait);if(!i)continue;let n=i.viewDistance<<4;this.entity.position.distance(t.position)>n||this.addViewer(t)}for(let t of this.viewers.values()){(!t.isAlive||!t.isTicking||this.dimension.entities.has(this.entity.uniqueId)===!1)&&this.removeViewer(t);let i=t.getTrait(g.PlayerChunkRenderingTrait);if(!i){this.removeViewer(t);continue}let n=i.viewDistance<<4;this.entity.position.distance(t.position)>n&&this.removeViewer(t)}}}};var B=require("@serenityjs/protocol"),F=class{constructor(e){this.serenity=e;e.commandPalette.register("slapperr","Creates slappers.",t=>{t.overload({action:[O,!0],subcommand:[S.StringEnum,!0],slapper:[S.StringEnum,!0],args:[S.StringEnum,!0]},i=>(i.origin instanceof S.Player&&this.onExecute(i.origin,[i.action.result,i.subcommand.result,i.slapper.result,i.args.result]),{message:void 0}))},t=>{t.origin instanceof S.Player&&t.origin.sendMessage("Usage: /slapper help")})}onExecute(e,t){if(!e.isOp){e.sendMessage("You do not have permission to use this command.");return}switch(t[0]){case"chunklist":let i=e.getChunk();for(let[o,w]of i.getAllEntityStorages()){let L=w.get("identifier"),Q=L?L.valueOf():"unknown";e.sendMessage(`Entity ID: ${o}, Data: ${Q}`)}e.sendMessage("Finished listing entities in current chunk.");break;case"help":case"h":e.sendMessage("Slapper Command Help:"),e.sendMessage("/slapper create [name] [id] - Creates a slapper with the given name and id. "),e.sendMessage("/slapper remove [id] - Removes the slapper with the given id."),e.sendMessage("/slapper list - Lists all slappers in the current dimension."),e.sendMessage("/slapper addcmd [id] [cmd] - Adds a command to the slapper with the given id. (use . for spaces)"),e.sendMessage("/slapper removecmd [id] [cmd] - Removes a command from the slapper with the given id. (use . for spaces)"),e.sendMessage("/slapper tpme [id] - Teleports the slapper with the given id to you."),e.sendMessage("/slapper tp [id] - Teleports you to the slapper with the given id."),e.sendMessage("/slapper setname [id] [new.name] - Sets the name of the slapper with the given id. (use . for spaces)"),e.sendMessage("/slapper chunklist - Lists all entities in the current chunk.");break;case"setname":case"sn":let n=parseInt(t[1]+"s");if(isNaN(n)){e.sendMessage("Invalid slapper ID: "+t[1]);return}let r=t[2]||"Slapper.slapper";r=r.replace("."," ");let d=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===n:!1);d&&d.hasTrait(a)?(d.getTrait(a).setDisplayName(r),e.sendMessage(`Slapper with id "${n}" has been renamed to "${r}".`)):e.sendMessage(`No slapper found with id "${n}".`);break;case"tpme":let u=parseInt(t[1]+"s");if(isNaN(u)){e.sendMessage("Invalid slapper ID.");return}let m=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===u:!1);m?.hasTrait(a)?(m.teleport(e.position.add(new B.Vector3f(0,1,0))),e.sendMessage(`Slapper with id "${u}" has been teleported to you.`)):e.sendMessage(`No slapper found with id "${u}".`);break;case"tp":let l=parseInt(t[1]);if(isNaN(l)){e.sendMessage("Invalid slapper ID.");return}let P=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===l:!1);P?.hasTrait(a)?(e.teleport(P.position),e.sendMessage(`Teleported to slapper with id "${l}".`)):e.sendMessage(`No slapper found with id "${l}".`);break;case"removecmd":case"rc":let v=parseInt(t[1]);if(isNaN(v)){e.sendMessage("Invalid slapper ID.");return}let E=t[2]??"say.hello";E=E.replace("."," ");let z=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===v:!1);z?.hasTrait(a)?(z.getTrait(a).removeCommand(E),e.sendMessage(`Command "${E}" has been removed from slapper with id "${v}".`)):e.sendMessage(`No slapper found with id "${v}".`);break;case"addcmd":case"ac":let A=parseInt(t[1]),D=t[2]??"say.Hello!";if(D=D.replace("."," "),D.length===0){e.sendMessage("Command cannot be empty.");return}if(isNaN(A)){e.sendMessage("Invalid slapper ID.");return}let R=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===A:!1);R&&R.hasTrait(a)?(R.getTrait(a).addCommand(D),e.sendMessage(`Command "${D}" has been added to slapper with id "${A}".`)):e.sendMessage(`No slapper found with id "${A}".`);break;case"l":case"list":let U=[];for(let o of e.dimension.entities.values())o.hasTrait(a)&&U.push(o.getTrait(a));if(U.length===0){e.sendMessage("No slappers found in this dimension.");return}U.forEach(o=>{e.sendMessage(`Slapper ID: ${o.getId()}, Name: ${o.getDisplayName()} commands: [${o.getCommands().join(", ")}]`)});break;case"rm":case"remove":let N=parseInt(t[1]);if(isNaN(N)){e.sendMessage("Invalid slapper ID.");return}let C=Array.from(e.dimension.entities.values()).find(o=>o.hasTrait(a)?o.getTrait(a).getId()===N:!1);C&&C.hasTrait(a)?(C.despawn(),e.dimension.entities.delete(C.uniqueId),e.sendMessage(`Slapper with id "${N}" has been removed.`)):e.sendMessage(`No slapper found with id "${N}".`);break;case"create":case"c":case"new":case"add":case"criar":case"cc":let _=t[1]||"Slapper";_=_.replace("."," ");let J=t[2]?parseInt(t[2]+"s"):Math.floor(Math.random()*1e5),K=a.createPreStorage(e.position,e.skin.getSerialized(),_,a.generateUUID(),J,[],e.rotation),I=new S.Entity(e.dimension,"slapper_entity_type",{storage:K}),H=I.getTrait(a)??I.addTrait(a);I.position=e.position,I.addTrait(f),I.isAlive=!0,e.dimension.entities.set(I.uniqueId,I),e.sendMessage(`Custom entity created with ID: ${H.getId()} and Name: ${H.getDisplayName()}`);break;default:e.sendMessage("Unknown subcommand. Usage: /slapper <create [name]|remove [id]|list|addcmd [id] [cmd]|removecmd [id] [cmd]>");break}}},O=class extends S.CustomEnum{static identifier="slapper_cmd";static options=["create","remove","list","addcmd","removecmd","tpme","tp","setname","chunklist","help"];optional=!0;static strict=!1;validate(e){return!0}};var $=require("@serenityjs/core");var j=require("console"),q=class extends Y.Plugin{constructor(){super("NitySlappers","1.0.0")}onInitialize(){new F(this.serenity),this.serenity.before($.WorldEvent.WorldInitialize,({world:e})=>(e.entityPalette.registerTrait(a),e.entityPalette.registerTrait(f),e.entityPalette.registerType(new $.CustomEntityType("slapper_entity_type")),!0)),(0,j.log)("[NitySlappers] Plugin initialized.")}},se=new q;
